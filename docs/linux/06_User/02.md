# 配置文件

在 Linux 系统中，用户和用户组的管理依托于一套层次化的配置文件体系。这些文件不仅承载着用户身份标识与权限分配的核心数据，更是构建系统安全策略的基础框架。通过这些全局配置文件，系统能够精确地定义用户的登录信息、权限范围、所属用户组等关键内容，从而实现对用户行为的有效管理和对系统资源的安全控制。

## /etc/passwd

`/etc/passwd` 文件存储了用户的基本信息，包括用户名、用户 ID（UID）、默认用户组 ID（GID）、用户描述、家目录路径以及默认 Shell 等。这些信息是用户登录和系统识别用户身份的基础。

:::code-group

```shell [/etc/pawssd]
root:x:0:0:root:/root:/bin/bash
bin:x:1:1:bin:/bin:/sbin/nologin
daemon:x:2:2:daemon:/sbin:/sbin/nologin
adm:x:3:4:adm:/var/adm:/sbin/nologin
lp:x:4:7:lp:/var/spool/lpd:/sbin/nologin
sync:x:5:0:sync:/sbin:/bin/sync
shutdown:x:6:0:shutdown:/sbin:/sbin/shutdown
halt:x:7:0:halt:/sbin:/sbin/halt
mail:x:8:12:mail:/var/spool/mail:/sbin/nologin
operator:x:11:0:operator:/root:/sbin/nologin
games:x:12:100:games:/usr/games:/sbin/nologin
ftp:x:14:50:FTP User:/var/ftp:/sbin/nologin
nobody:x:65534:65534:Kernel Overflow User:/:/sbin/nologin
tss:x:59:59:Account used for TPM access:/:/usr/sbin/nologin
systemd-coredump:x:999:997:systemd Core Dumper:/:/sbin/nologin
dbus:x:81:81:System message bus:/:/sbin/nologin
sssd:x:998:996:User for sssd:/:/sbin/nologin
chrony:x:997:995:chrony system user:/var/lib/chrony:/sbin/nologin
sshd:x:74:74:Privilege-separated SSH:/usr/share/empty.sshd:/usr/sbin/nologin
……
```

:::

可以看到 Linux 系统中的每个用户都在 `/etc/passwd` 文件中有一个对应的记录行，它记录了这个用户的一些基本属性。这个文件对所有用户都是可读的，`/etc/passwd` 中一行记录对应着一个用户，每行记录又被冒号 `:` 分隔为 7 个字段：

```shell
用户名：密码占位符：UID:GID: 用户信息描述：用户主目录：用户登录 Shell
```

| 字段名称              | 说明                                                                 | 补充                                                                             |
| --------------------- | -------------------------------------------------------------------- | -------------------------------------------------------------------------------- |
| 用户名                | 系统登录与身份识别的唯一标识，由字母、数字、下划线组成               | 区分大小写，系统通过用户名匹配对应用户记录，确定权限和属性                       |
| 密码占位符            | 现代 Linux 中仅作为密码影子化标识，不存储实际加密密码                | 通常显示为 `x` 或 `*`，真实加密密码存储在 /etc/shadow，登录时通过用户名比对验证  |
| UID                   | 唯一标识用户的数字编号（范围 0-65535），是系统底层识别用户的核心凭证 | UID=0 对应超级用户 root（最高权限）；普通用户 UID 通常从 1000 开始               |
| GID                   | 标识用户所属的基本组，是文件组权限判定的核心依据                     | 用户至少属于 1 个基本组，可加入多个附加组；组权限与用户权限叠加生效              |
| 用户信息描述（GECOS） | 对用户的描述性信息，无严格格式要求                                   | 通常包含真实姓名、办公地点、联系电话等，方便管理员快速了解用户信息               |
| 用户主目录            | 用户登录后的默认工作目录，存储个人文件、配置等数据                   | 用户对主目录拥有完整权限（rwx），不同用户主目录相互独立，保障数据隔离            |
| 用户登录 Shell        | 接收并执行用户命令的解释器，是用户与系统交互的接口                   | 默认 Shell 为 `/bin/bash`；`/sbin/nologin/` 表示该用户无法登录（多用于系统服务） |

> [!TIP] 默认用户
> 在 Linux 系统中，即使是一个全新的安装，也会存在许多默认用户。这些用户并不是用于日常登录的普通用户，而是系统用户（system users），它们的存在是为了满足系统服务、守护进程（daemons）和特定功能的需要。这些用户通常具有特定的权限和限制，以确保系统的安全性和稳定性。

## /etc/shadow

`/etc/shadow` 文件是 Linux 系统中用于存储用户密码和密码相关策略的核心文件。为了增强系统的安全性，现代 Linux 系统将用户密码从 `/etc/passwd` 文件中分离出来，并存储在 `/etc/shadow` 文件中。这个文件只有 root 用户和特定的系统进程可以访问，从而保护了密码信息的安全性。

:::code-group

```shell [/etc/shadow]
root:$6$9dGlhMoEUng5lWby$RFSTfWO5GH/Cen49s9.5I7sXkGC5jA0R76e9VDHX.1psMU/biK0olqti/np3vvwkEGq9e0Zu7qQmsnzMoo3p30::0:99999:7:::
bin:*:19820:0:99999:7:::
daemon:*:19820:0:99999:7:::
adm:*:19820:0:99999:7:::
lp:*:19820:0:99999:7:::
sync:*:19820:0:99999:7:::
shutdown:*:19820:0:99999:7:::
halt:*:19820:0:99999:7:::
mail:*:19820:0:99999:7:::
operator:*:19820:0:99999:7:::
games:*:19820:0:99999:7:::
ftp:*:19820:0:99999:7:::
nobody:*:19820:0:99999:7:::
tss:!!:20045::::::
systemd-coredump:!!:20045::::::
dbus:!!:20045::::::
sssd:!!:20045::::::
chrony:!!:20045::::::
sshd:!!:20045::::::
```

:::

`/etc/shadow` 中的记录行与`/etc/passwd` 中的一一对应，它由 `pwconv` 命令根据 `/etc/passwd` 中的数据自动产生，它的文件格式与 `/etc/passwd` 类似，共有 9 个字段组成：

```shell
用户名：加密密码：最后一次修改密码的时间：密码最小使用期限：密码最大使用期限：密码过期警告天数：密码不活动天数：账号过期时间：保留字段
```

| 字段名称               | 说明                                                   | 补充                                                                                |
| ---------------------- | ------------------------------------------------------ | ----------------------------------------------------------------------------------- |
| 用户名                 | 系统唯一标识用户的名称，与 /etc/passwd 用户名一一对应  | 由字母、数字、下划线组成，区分大小写；登录时通过用户名匹配 /etc/shadow 中的加密密码 |
| 加密密码               | 存储经加密算法（如 SHA-512）处理后的用户密码           | 以长字符串形式呈现；字段为 `*` 或 `!` 时，账号被锁定，无法密码登录                  |
| 最后一次修改密码的时间 | 从 1970-01-01 UTC 到最后改密码的天数（整数）           | 用于计算密码使用期限，判断密码是否过期                                              |
| 密码最小使用期限       | 改密码后，需间隔多少天才能再次修改（整数，单位：天）   | 防止频繁改密码，增强安全性；示例：设为 7 则 7 天内不可重复修改                      |
| 密码最大使用期限       | 密码的有效天数（整数），从最后改密码日起算             | 强制定期换密码；过期后登录会提示改密码，否则可能无法正常使用系统                    |
| 密码过期警告天数       | 密码到期前，提前多少天向用户发出警告（整数，单位：天） | 提醒及时改密码；示例：设为 7 则到期前 7 天登录时触发提示                            |
| 密码不活动天数         | 密码过期后，多少天内未改则锁定账号（整数，单位：天）   | 避免过期密码长期未更换的安全风险；示例：设为 14 则过期 14 天后账号锁定              |
| 账号过期时间           | 从 1970-01-01 UTC 到账号禁用日期的天数（整数）         | 到期后账号自动禁用，与密码是否过期无关；适用于临时账号（如访客、临时员工）          |
| 保留字段               | 为系统未来功能扩展预留的字段                           | 目前通常为空字符串，不影响系统运行和用户认证功能。                                  |

> [!TIP] pwconv
> pwconv 是一个 Linux 系统管理命令，用于将用户密码从 `/etc/passwd` 文件迁移到更安全的 `/etc/shadow` 文件中，从而实现「投影密码」（shadow password）功能。这个过程称为「投影」（shadowing），目的是提高系统安全性，因为 `/etc/shadow` 文件的权限设置更为严格，只有超级用户（root）可以访问。

## /etc/group

将用户分组是 Linux 系统中对用户进行管理及控制访问权限的一种重要手段。每个用户都至少属于一个用户组，称为主组（Primary Group），同时也可以属于多个附加组（Secondary Groups）。用户组的合理划分和管理能够有效简化权限分配，增强系统的安全性和可管理性。

:::code-group

```shell [/etc/group]
root:x:0:
bin:x:1:
daemon:x:2:
sys:x:3:
adm:x:4:
tty:x:5:
disk:x:6:
lp:x:7:
mem:x:8:
kmem:x:9:
wheel:x:10:john
cdrom:x:11:
mail:x:12:
man:x:15:
dialout:x:18:
floppy:x:19:
games:x:20:john
tape:x:33:
video:x:39:
ftp:x:50:
lock:x:54:
audio:x:63:
users:x:100:
nobody:x:65534:
utmp:x:22:
utempter:x:35:
ssh_keys:x:101:
tss:x:59:
input:x:999:
kvm:x:36:
render:x:998:
systemd-journal:x:190:
systemd-coredump:x:997:
dbus:x:81:
sssd:x:996:
chrony:x:995:
sshd:x:74:
```

:::

用户组的所有信息都存放在 `/etc/group` 文件中。此文件的格式类似于 `/etc/passwd` 文件，由冒号（`:`）分隔 4 个字段，每个字段都有特定的含义：

```shell
组名：密码：GID: 组成员列表
```

| 字段名称   | 说明                                                        | 补充                                                                                                                           |
| ---------- | ----------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------ |
| 组名       | 用户组的唯一标识，方便识别和管理，区分大小写                | 由字母、数字、下划线组成；设置文件权限、执行任务时，通过组名指定目标用户集合                                                   |
| 密码       | 理论存储组密码，现代 Linux 系统极少使用，多依赖其他授权机制 | 字段为 `x` 表示密码影子化（实际存储在 /etc/gshadow）；为空字符串则无组密码；仅特定场景用于限制组资源访问（需输组密码临时加入） |
| GID        | 用户组的唯一数字标识符，系统内部识别组的核心凭证            | 类似用户 UID 的作用，用于权限判定和文件访问控制；通常 0-499 为系统保留 GID，500 及以上为普通用户组 GID                         |
| 组成员列表 | 列出该组的所有用户，明确用户与组的关联关系                  | 多个用户名用逗号分隔；用户若属于多个组，会在对应组的该字段中重复出现；组权限会作用于所有成员                                   |

> [!TIP] 主组和附加组
> 主组也称为基本组或主要组，是用户在登录系统时所属的默认组。当用户创建文件或目录时，如果没有特别指定，文件或目录的所属组通常就是用户的主组。系统在进行权限检查时，会根据文件或目录的属组权限以及用户的主组身份来确定用户是否具有相应的访问权限。主组在一定程度上代表了用户的主要身份属性，用于系统对用户进行分类和管理，方便进行整体的权限规划和资源分配。
>
> 附加组是用户除主组之外所属的其他组，用户可以同时属于多个附加组。通过将用户添加到不同的附加组，可以让用户获得对更多资源的访问权限。例如，一个用户可能同时需要访问开发相关资源和测试相关资源，就可以将其加入到开发组和测试组这两个附加组中，从而方便地实现对不同资源的访问控制。

## /etc/gshadow

`/etc/gshadow` 文件是 Linux 系统中用于存储用户组密码和组管理信息的配置文件。它类似于 `/etc/shadow` 文件，但专门用于用户组的管理。该文件的权限通常设置为只有 root 用户和特定用户组可以访问，以确保组密码和管理信息的安全。

:::code-group

```shell [/etc/gshadow]
root:::
bin:::
daemon:::
sys:::
adm:::
tty:::
disk:::
lp:::
mem:::
kmem:::
wheel:::john
cdrom:::
mail:::
man:::
dialout:::
floppy:::
games:::john
tape:::
video:::
ftp:::
lock:::
audio:::
users:::
nobody:::
utmp:!::
utempter:!::
ssh_keys:!::
tss:!::
input:!::
kvm:!::
render:!::
systemd-journal:!::
systemd-coredump:!::
dbus:!::
sssd:!::
chrony:!::
sshd:!::
```

:::

`/etc/gshadow` 文件中的每一行对应一个用户组，字段由冒号（`:`）分隔，共有四个字段：

```shell
组名：加密密码：组管理员：成员列表
```

| 字段名称 | 说明                                                                   | 补充                                                                                            |
| -------- | ---------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------- |
| 组名     | 用户组的唯一标识符，用于系统管理和权限设置，是指定操作目标组的核心依据 | 方便管理员直观识别管理组（如分配文件权限），用户可通过组名执行查看成员、切换组等操作            |
| 加密密码 | 存储经加密处理的组密码，核心用于 `newgrp` 命令的身份验证               | 仅在需严格控制组资源访问时使用，知道密码的用户可临时切换到该组，获取对应组权限访问资源          |
| 组管理员 | 记录该组的管理员用户名，拥有组的专属管理权限                           | 可添加 / 删除组成员、修改组属性等；分散管理权限，减轻系统管理员负担，提升管理灵活性             |
| 成员列表 | 列出该组的所有成员用户名，明确用户与组的归属关系                       | 系统通过该字段判定用户所属组，结合 /etc/group 记录，综合主组 / 附加组权限，控制用户对资源的访问 |

## /etc/login.defs

``/etc/login.defs`` 是 Linux 系统中用于定义用户账户和密码策略默认设置的重要配置文件。它在用户创建、管理以及登录过程中发挥关键作用，为系统管理员提供了集中管理用户账户行为和安全策略的工具。

需要留意的是，该文件内针对用户的默认配置并不适用于 `root` 用户。`root` 用户作为系统的超级管理员，其权限和相关属性有着独立且特殊的设定机制，不受 ``/etc/login.defs`` 中普通用户默认配置的约束 。

此外，当 `/etc/login.defs` 文件中的配置与 `/etc/passwd` 和 `/etc/shadow` 文件里的用户信息出现冲突时，系统将优先采用 `/etc/passwd` 和 `/etc/shadow` 文件中的信息。这是因为 `/etc/login.defs` 中的配置更多是为用户账户创建及一般性密码策略提供默认值，在具体用户信息存在冲突时，后两者文件具有更高的优先级，以确保用户账户信息的准确性和系统运行的稳定性 。

`/etc/login.defs` 文件中有非常多的注释和空行，可以使用 grep 命令进行过滤，只查看实际生效的配置项：

```bash
grep -vE '^\s*$|^\s*#' /etc/login.defs
```

```console
MAIL_DIR        /var/spool/mail
UMASK           022
HOME_MODE       0700
PASS_MAX_DAYS   99999
PASS_MIN_DAYS   0
PASS_MIN_LEN    8
PASS_WARN_AGE   7
UID_MIN                  1000
UID_MAX                 60000
SYS_UID_MIN               201
SYS_UID_MAX               999
SUB_UID_MIN                524288
SUB_UID_MAX             600100000
SUB_UID_COUNT               65536
GID_MIN                  1000
GID_MAX                 60000
SYS_GID_MIN               201
SYS_GID_MAX               999
SUB_GID_MIN                524288
SUB_GID_MAX             600100000
SUB_GID_COUNT               65536
PASS_CHANGE_TRIES       5
PASS_ALWAYS_WARN        yes
ENCRYPT_METHOD YESCRYPT
USERGROUPS_ENAB yes
CREATE_HOME     yes
HMAC_CRYPTO_ALGO SHA512
```

:::

邮件和用户主目录相关：

| 配置项      | 值                | 说明                                                                                                                       |
| ----------- | ----------------- | -------------------------------------------------------------------------------------------------------------------------- |
| `MAIL_DIR`  | `/var/spool/mail` | 指定用户邮件存储的目录路径                                                                                                 |
| `UMASK`     | `022`             | 定义用户创建文件和目录时的默认权限掩码。`022` 表示文件默认权限为 `644` `(-rw-r--r--)`，目录默认权限为 `755` `(drwxr-xr-x)` |
| `HOME_MODE` | `0700`            | 定义用户主目录的默认权限。`0700` 表示用户主目录的权限为 `drwx------`，即只有用户自己可以访问                               |

用户和组 ID 的范围：

| 配置项          | 值          | 说明                            |
| --------------- | ----------- | ------------------------------- |
| `UID_MIN`       | `1000`      | 普通用户的最小 UID 值           |
| `UID_MAX`       | `60000`     | 普通用户的最大 UID 值           |
| `SYS_UID_MIN`   | `201`       | 系统用户的最小 UID 值           |
| `SYS_UID_MAX`   | `999`       | 系统用户的最大 UID 值           |
| `SUB_UID_MIN`   | `100000`    | 子用户（sub-user）的最小 UID 值 |
| `SUB_UID_MAX`   | `600100000` | 子用户的最大 UID 值             |
| `SUB_UID_COUNT` | `65536`     | 为每个用户分配的子用户 UID 数量 |

> [!TIP] 子用户
> 子用户是一种特殊的用户类型，通常用于特定场景（如容器化环境或多用户管理）中，以隔离用户权限并减少对系统全局环境的影响。子用户可以通过映射机制将一个用户的权限限制在特定的命名空间（namespace）中，从而实现更高的安全性和隔离性，通常用于容器、虚拟化或权限精细控制场景。
>
> 子用户的创建和管理与普通用户类似，但它们的 UID 和 GID 范围通常被分配在更高的区间，以避免与系统用户和普通用户冲突。这些子用户通常用于容器化环境或多用户场景中，以实现更好的隔离和权限管理。

用户组 ID 的范围：

| 配置项          | 值          | 说明                            |
| --------------- | ----------- | ------------------------------- |
| `GID_MIN`       | `1000`      | 普通用户组的最小 GID 值         |
| `GID_MAX`       | `60000`     | 普通用户组的最大 GID 值         |
| `SYS_GID_MIN`   | `201`       | 系统用户组的最小 GID 值         |
| `SYS_GID_MAX`   | `999`       | 系统用户组的最大 GID 值         |
| `SUB_GID_MIN`   | `100000`    | 子用户组的最小 GID 值           |
| `SUB_GID_MAX`   | `600100000` | 子用户组的最大 GID 值           |
| `SUB_GID_COUNT` | `65536`     | 为每个用户分配的子用户 GID 数量 |

> [!TIP] 子用户组
> 子用户组（Sub-Group）的概念与子用户（Sub-User）类似，主要用于支持用户命名空间（User Namespace）和容器化环境。这些特性允许在隔离的环境中为每个用户分配独立的用户组 ID（GID）范围，从而实现更细粒度的权限管理和资源隔离。
>
> 在容器化环境中（如 Docker），一个用户可能需要在容器内部拥有多个用户组，但这些用户组的 GID 需要与宿主机上的用户组隔离。为此，Linux 系统引入了子用户组的概念，允许为每个用户分配一个独立的 GID 范围。

密码策略：

| 配置项                 | 值       | 说明                                                         |
| ---------------------- | -------- | ------------------------------------------------------------ |
| `PASS_MAX_DAYS`        | `99999`  | 密码的最大有效期（天数）。`99999` 表示密码几乎永不过期       |
| `PASS_MIN_DAYS`        | `0`      | 用户在更改密码后必须等待的天数。`0` 表示用户可以随时更改密码 |
| `PASS_WARN_AGE`        | `7`      | 密码过期前的警告天数。7 表示在密码过期前 7 天开始提醒用户    |
| `ENCRYPT_METHOD`       | `SHA512` | 指定密码加密方法。SHA512 是一种安全的加密算法                |
| `SHA_CRYPT_MAX_ROUNDS` | `100000` | SHA 加密算法的最大迭代次数，用于增加密码破解难度             |

用户管理：

| 配置项             | 值       | 说明                                                   |
| ------------------ | -------- | ------------------------------------------------------ |
| `USERGROUPS_ENAB`  | `yes`    | 是否允许删除用户时同时删除其初始用户组。`yes` 表示允许 |
| `CREATE_HOME`      | `yes`    | 是否在创建用户时自动创建用户主目录。`yes` 表示自动创建 |
| `HMAC_CRYPTO_ALGO` | `SHA512` | 指定用于 HMAC 加密的算法。SHA512 是一种安全的哈希算法  |
